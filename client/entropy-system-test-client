#!/usr/bin/python
serverHost = "localhost"
serverPort = 999

import sys, os
import socket
socket.setdefaulttimeout(5)
sys.path.insert(0,'/usr/lib/entropy/libraries')
sys.path.insert(0,'/usr/lib/entropy/client')
sys.path.insert(0,'../libraries')
sys.path.insert(0,'../client')

try:
    import cPickle as pickle
except ImportError:
    import pickle
try:
    import cStringIO as stringio
except ImportError:
    import StringIO as stringio
import dumpTools

def spawn(cmd, silent = False, getobj = False):

    # connect
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        s.connect((serverHost, serverPort))
    except socket.error, e:
        if e[0] == 111:
            print "no daemon running"
            sys.exit(1)
        else:
            raise

    # send command
    s.sendall(cmd)

    # get data
    data = ''
    while 1:
        try:
            x = s.recv(1024)
        except socket.timeout, e:
            print "connection timed out"
            sys.exit(3)
        if not x:
            break
        data += x
        if not silent:
            sys.stdout.write(x)
            sys.stdout.flush()

    if getobj:
        f = stringio.StringIO(data)
        data = dumpTools.unserialize(f)
        f.close()

    s.close()
    return data

# 1st step, get session
session = spawn("begin", silent = True)
print "session is:",session

# 2nd step, run the command
#s.send("reposync reponames=['sabayonlinux.org'] forceUpdate=True")
result = spawn("%s match 'x11-libs/qt'" % (session,), silent = True)
print "spawn result is:",repr(result)

if result != chr(0)*2:
    print "cannot continue, error:",repr(result)
    sys.exit(2)

# 3rd step, get rc
rc = spawn("%s rc" % (session,), silent = True, getobj = True)
print "REAL returned data:",repr(rc)

# 4th step, end session
rc = spawn("%s end" % (session,), silent = True)
print "END session result",repr(rc)

sys.exit(0)